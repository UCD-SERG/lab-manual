Before publishing new changes, it is important to ensure that the code has been tested and well-documented. GitHub makes it possible to document all of these changes in a pull request. Pull requests can be used to describe changes in a branch that are ready to be merged with the base branch (more information in the [GitHub](#Github) section).

This section provides guidance on both constructing effective pull requests and reviewing code submitted by others. Much of the content in this section is adapted from the Tidyverse code review principles [@tidyverse2023codereview], which provides excellent principles for code review in R package development.

## Constructing Pull Requests

### Write Focused PRs

A focused pull request is **one self-contained change** that addresses just one thing. Writing focused PRs has several benefits:

- **Faster reviews**: It's easier for a reviewer to find 5-10 minutes to review a single bug fix than to set aside an hour for one large PR implementing many features.
- **More thorough reviews**: Large PRs with many changes can overwhelm reviewers, leading to important points being missed.
- **Fewer bugs**: Smaller changes make it easier to reason about impacts and identify potential issues.
- **Easier to merge**: Large PRs take longer and are more likely to have merge conflicts.
- **Less wasted work**: If the overall direction is wrong, you've wasted less time on a small PR.

As a guideline, 100 lines is usually a reasonable size for a PR, and 1000 lines is usually too large. However, the number of files affected also matters—a 200-line change in one file might be fine, but the same change spread across 50 files is usually too large.

### Writing PR Descriptions

When you submit a pull request, include a detailed PR title and description. A comprehensive description helps your reviewer and provides valuable historical context.

**PR Title**: The title should be a short summary (ideally under 72 characters) of what is being done. It should be informative enough that future developers can understand what the PR did without reading the full description.

Poor titles that lack context:

- "Fix bug"
- "Add patch"
- "Moving code from A to B"

Better titles that summarize the actual change:

- "Fix missing value handling in data processing function"
- "Add support for custom date formats in import functions"

**PR Description Body**: The description should provide context that helps the reviewer understand your PR. Consider including:

- A brief description of the problem being solved
- Links to related issues (e.g., "Closes #123" or "Related to #456")
- A before/after example showing changed behavior
- Possible shortcomings of the approach being used
- For complex PRs, a suggested reading order for the reviewer
- The `Files` tab of a Pull Request page on GitHub allows you to annotate 
your pull request with inline comments. 
These comments are not part of the source files; they only exist in GitHub's metadata.
Use these comments to explain *changes* whose reasoning might not be self-apparent
to a reviewer.

### Add Tests

Focused PRs should include related test code. A PR that adds or changes logic should be accompanied by new or updated tests for the new behavior. Pure refactoring PRs should also be covered by tests—if tests don't exist for code you're refactoring, add them in a separate PR first to validate that behavior is unchanged.

### Separate Out Refactorings

It's usually best to do refactorings in a separate PR from feature changes or bug fixes. For example, moving and renaming a function should be in a different PR from fixing a bug in that function. This makes it much easier for reviewers to understand the changes introduced by each PR.

Small cleanups (like fixing a local variable name) can be included in a feature change or bug fix PR, but large refactorings should be separate.

## Reviewing Pull Requests

### Purpose of Code Review

The primary purpose of code review is to ensure that the overall code health of our projects improves over time. Reviewers should balance the need to make forward progress with the importance of maintaining code quality.

**Key principle**: Reviewers should favor approving a PR once it is in a state where it definitely improves the overall code health of the system, even if the PR isn't perfect. There is no such thing as "perfect" code—there is only better code. Rather than seeking perfection, seek continuous improvement.

### Monitoring PRs Awaiting Your Review

To ensure timely code reviews,
bookmark GitHub's review-requested page and check it regularly (at least daily):

- **General bookmark**: <https://github.com/pulls/review-requested>
shows all PRs across GitHub where you've been requested as a reviewer

- **Project-specific bookmark**: For frequently-reviewed repositories,
you can bookmark project-specific versions using GitHub's search syntax.
For example, to see PRs awaiting your review in this repository:
<https://github.com/UCD-SERG/lab-manual/pulls/review-requested/YOUR-USERNAME>
(replace `YOUR-USERNAME` with your GitHub username)

Checking these pages regularly helps ensure that PRs don't languish waiting for review,
which is important for maintaining team productivity and code quality.

### Writing Review Comments

When reviewing code, maintain courtesy and respect while being clear and helpful:

- Comment on the **code**, not the author
- Explain **why** you're making suggestions (reference best practices, design patterns, or how the suggestion improves code health)
- Balance pointing out problems with providing guidance (help authors learn while being constructive)
- Highlight positive aspects too—if you see good practices, comment on those to reinforce them

**Poor comment**: "Why did you use this approach when there's obviously a better way?"

**Better comment**: "This approach adds complexity without clear benefits. Consider using [alternative approach] instead, which would simplify the logic and improve readability."

### Mentoring Through Review

Code review is an excellent opportunity for mentoring. As a reviewer:

- Leave comments that help authors learn something new
- Link to relevant sections of style guides or best practices documentation
- Consider pair programming for complex reviews—live review sessions can be very effective for teaching

### Giving Constructive Feedback

In general, it is the author's responsibility to fix a PR, not the reviewer's. Strike a balance between pointing out problems and providing direct guidance. Sometimes pointing out issues and letting the author decide on a solution helps them learn and may result in a better solution since they are closer to the code.

For very small tweaks (typos, comment additions),
use GitHub's suggestion feature
to allow authors to quickly accept changes directly in the UI.

![GitHub's suggestion feature in a PR review comment](assets/images/github-suggestion-feature.png){#fig-github-suggestion-feature}

### Ignoring Auto-Generated Files

When reviewing pull requests in R package repositories,
you can typically ignore changes to `.Rd` files in the `man/` directory.
These are R documentation files automatically generated by [`{roxygen2}`](https://roxygen2.r-lib.org/)
from special comments in the R source code (see @sec-documenting-code).

**Why ignore `.Rd` files?**

- They are auto-generated and should never be manually edited
- Changes to `.Rd` files simply reflect changes already visible in the roxygen2 comments
- Reviewing the source roxygen2 comments is more informative and efficient
- The `.Rd` files will be regenerated during the package build process

**What to review instead:**

Focus your review on the roxygen2 documentation comments in the actual R source files (`.R` files in the `R/` directory).
These special comments start with `#'` and appear immediately before function definitions.
Any changes to function documentation will be visible there.

If the repository has a preview workflow
(such as pkgdown for R packages or Quarto for documentation sites),
you can also review the rendered documentation in the preview build.
The preview workflow should automatically post a comment on the PR
containing a link to a preview version of the revised documentation.

![Example of an automated PR preview comment posted by GitHub Actions](assets/images/quarto-preview-comment.png){#fig-preview-comment}

**GitHub review tip:**

In GitHub's pull request "Files changed" view,
you can click the three dots (`...`) next to a file and select "View file" to hide it from the diff view.
This helps you focus on the meaningful changes.

### Reviewing Copilot-Generated Pull Requests

When reviewing pull requests created by GitHub Copilot coding agents,
apply the same standards and principles as any other PR,
but be aware of some unique considerations:

**Workflow approval requirements:**

- **You must manually approve GitHub Actions workflows** for Copilot PRs
- This is a security measure because Copilot can modify any file, including workflow files themselves
- Click the approval button in the Actions tab or on the PR to trigger workflows
- There is currently no way to bypass this manual approval,
  even if you are the repository owner

**Review focus areas:**

- **Verify the solution addresses the issue**: Ensure Copilot understood the requirements correctly
- **Check for over-engineering**: Copilot may sometimes add unnecessary complexity or features beyond what was requested
- **Review test coverage**: Verify that tests are appropriate and comprehensive
- **Check documentation**: Ensure documentation is clear and follows project conventions
- **Look for edge cases**: AI-generated code may miss edge cases or error handling

**Iterating on Copilot PRs:**

When you find issues in a Copilot PR,
you have two options:

1. **Request changes from Copilot**: Leave review comments and ask Copilot to address them.
   This works well for complex changes or when you want to see how Copilot interprets your feedback.

2. **Make direct changes yourself**: Push commits directly to the Copilot PR branch.
   This is often faster for simple fixes like typos, formatting, or small adjustments.

For quick fixes,
you can often make changes faster than writing review comments
and waiting for Copilot to respond.

**Best practices:**

- **Don't push while Copilot is working**: Wait for Copilot to complete its current iteration before pushing your own changes to avoid merge conflicts
- **Review incrementally**: If a Copilot PR is large, review it in stages as the agent updates it rather than waiting until the end
- **Trust but verify**: Copilot is a powerful tool, but human review is essential for catching issues and ensuring quality

### Reviewing a Copilot PR You Didn't Create

When reviewing a pull request where someone else prompted Copilot to make changes,
follow these guidelines to avoid confusion and ensure smooth collaboration:

**The scenario:**

- One team member (the "prompter") assigned Copilot to work on an issue or explicitly prompted Copilot to start working
- The prompter may or may not be the same person who originally wrote the issue
  - In projects with a user base, users often submit issues (bug reports, feature requests)
  - A project maintainer then steps in, adds their perspective, and assigns the issue to Copilot
  - In this case, the maintainer who assigned Copilot is the prompter, not the original issue author
- Copilot created the PR with the prompter as co-author
- The prompter requested your review
- Copilot may have also automatically reviewed the PR

**As a non-prompter reviewer, your role is to provide feedback,
not to directly initiate more work by Copilot.**
The prompter should remain in control of when and how Copilot makes additional changes.

**Recommended review workflow:**

1. **Use "Comment" or "Request changes" based on the severity of issues**:
   - Use **"Comment"** for suggestions, questions, or minor issues that don't block merging
   - Use **"Request changes"** for significant issues that must be addressed before merging
   - Both options allow you to provide feedback without directly triggering Copilot

2. **Don't ask Copilot to make changes directly**:
   - Avoid using features that would trigger Copilot to start working immediately
   - Let the prompter decide whether to ask Copilot to address your comments or make changes themselves

3. **Write clear, actionable comments**:
   - Explain what needs to change and why
   - Suggest specific solutions when appropriate
   - The prompter will decide how to address your feedback

**For prompters (the person who prompted Copilot):**

After receiving reviews from other team members:

1. **Review all comments carefully**:
   - Decide which comments you agree with
   - Dismiss or respond to comments you don't entirely agree with
   - This ensures Copilot only addresses feedback you've validated

2. **Choose how to address valid feedback**:
   - **Option A**: Make the changes yourself (faster for simple fixes)
   - **Option B**: Ask Copilot to address the feedback (better for complex changes)
   - **Option C**: Add your own review summarizing which comments Copilot should address,
     then ask Copilot to respond to the open comment threads

3. **Maintain clear communication**:
   - Let reviewers know how you plan to address their feedback
   - Mark conversations as resolved after addressing them
   - Request re-review from humans after Copilot makes significant changes

**Transferring the prompter role:**

The original prompter can hand over a PR to another person,
who then becomes the new prompter with control over Copilot's work on that PR.
This might be useful when:

- The original prompter is unavailable or on leave
- Someone with different expertise needs to guide the remaining work
- Responsibilities are being redistributed within the team

To transfer the prompter role:

1. The original prompter should clearly communicate the handover to all reviewers
2. The new prompter should review the PR's history and any open feedback
3. The new prompter should take over responding to Copilot and managing future iterations
4. The team should update PR comments or description to reflect the current prompter if helpful

This workflow ensures the prompter maintains control over the development process
while benefiting from collaborative human review and Copilot's implementation capabilities.

### Using Copilot Review Before Human Review

Before requesting review from other humans,
**always have Copilot review your pull request first**—even if Copilot created the PR itself.
AI review provides fast,
thorough feedback that helps catch issues before involving human reviewers,
saving everyone time and improving code quality.

**Why review with Copilot first:**

- **AI has more bandwidth**: Copilot can review code immediately without competing priorities
- **Catch common issues early**: Copilot excels at identifying bugs, logic errors, security vulnerabilities, and style inconsistencies
- **Improve human review quality**: When humans review cleaner code, they can focus on higher-level concerns like design and architecture rather than basic issues
- **Learn from feedback**: Even experienced developers benefit from Copilot's perspective on best practices and potential improvements
- **Growing capabilities**: AI review capabilities continue to improve over time, making this investment increasingly valuable

**Copilot review workflow:**

1. **Assign Copilot as a reviewer**: 
   On your pull request page,
   assign Copilot to review the PR the same way you would assign any other reviewer.
   Click "Reviewers" in the right sidebar and select Copilot from the list.

2. **Review Copilot's comments**: 
   Once Copilot completes its review,
   carefully examine each comment.
   For each comment, decide whether you agree with the suggestion:
   
   - **If the comment is correct**: Address it by making code changes yourself or ask Copilot to apply the fix using GitHub's suggestion features
   - **If the comment is incorrect or not applicable**: Dismiss the comment with an explanation for why it doesn't apply
   - **If you're uncertain**: Seek a second opinion from a human reviewer or do additional research

3. **Request another Copilot review**: 
   After addressing or dismissing all comments,
   request another review from Copilot.
   This creates an iterative improvement process.

4. **Iterate until satisfied**: 
   Repeat the review-and-address cycle until Copilot stops providing valuable suggestions.
   This typically takes 1-3 iterations depending on the complexity of the changes.

5. **Request human review**: 
   Only after you've addressed Copilot's feedback should you request review from human team members.
   At this point,
   the code should be in better shape,
   allowing human reviewers to focus on higher-level concerns.

**Important considerations:**

- **Copilot isn't perfect**: AI review can produce false positives or miss important issues. Always apply your own judgment when evaluating Copilot's suggestions.
- **Don't blindly accept all suggestions**: Some of Copilot's recommendations may not fit your specific context or requirements. It's perfectly appropriate to dismiss comments that don't apply.
- **Human review remains essential**: Copilot review supplements but does not replace human code review. Humans bring domain knowledge, understanding of business requirements, and judgment about trade-offs that AI cannot replicate.
- **Document dismissals**: When dismissing Copilot comments, briefly explain why. This helps human reviewers understand your reasoning and can serve as documentation for future reference.

**For pull request authors:**

Even if you're highly experienced,
treating Copilot review as a required pre-review step helps maintain code quality
and makes the best use of everyone's time.
The few minutes spent on Copilot review often save hours of back-and-forth with human reviewers.

**For human reviewers:**

When you receive a PR for review,
check whether the author has completed the Copilot review process.
If Copilot hasn't reviewed the PR yet,
consider asking the author to complete that step first before you invest time in review.
This ensures you're reviewing code that has already been through initial automated quality checks.

## Creating a Pull Request Template

GitHub allows you to create a pull request template in a repository to standardize the information in pull requests. When you add a template, everyone will automatically see its contents in the pull request body.

Follow these steps to add a pull request template:

1. On GitHub, navigate to the main page of the repository.
2. Above the file list, click `Create new file`.
3. Name the file `pull_request_template.md`. GitHub will not recognize this as the template if it is named anything else. The file must be on the default branch.
    - To store the file in a hidden directory, name it `.github/pull_request_template.md`.
4. In the body of the new file, add your pull request template.

Here is an example pull request template:

```text
# Description

## Summary of change

Please include a summary of the change, including any new functions added and example usage.

## Related Issues

Closes #(issue number)
Related to #(issue number)

## Testing

Describe how this change has been tested.

## Checklist

- [ ] Tests added/updated
- [ ] Documentation updated
- [ ] Code follows project style guidelines

## Who should review the pull request?

@username

```
